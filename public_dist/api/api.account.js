let fs=require("fs"),path=require("path"),UserModel=require("../model/user").UserModel,compressData=require("../util/compression").compressData,SetToken=require("./api.auth").SetToken,dataEncrypt=require("../util/crpyto").dataEncrypt,ResultResponse=require("../util/resultResponse");async function Register(e){try{for(var s in e)if("name"!==s&&"birth"!==s&&"gender"!==s&&"pw"!==s&&"job"!==s){var t,a=new Object,o=("id"===s?a[s]=e[s]:a[s+".value"]=e[s],await UserModel.findOne(a));if(o)return t=`register ${s} exists`,new ResultResponse(403,null,t)}var i=new UserModel(e);i.pw=compressData(i.pw),i.email={value:e.email,isPublic:!0},i.phone={value:e.phone,isPublic:!0},i.birth={value:e.birth,isPublic:!0},i.profileImg=null;let n=i.id,r=path.join(__dirname,"..","..","/"+process.env.FILE_DIRECTORY_NAME);return fs.mkdir(path.join(""+r,n),e=>{if(e)return console.log(e);fs.mkdir(path.join(r+"/"+n,"profile"),e=>{if(e)return console.log(e)}),fs.mkdir(path.join(r+"/"+n,"file"),e=>{if(e)return console.log(e)})}),i.save(),new ResultResponse(200)}catch(e){i=new ResultResponse(404,e.stack,e.message);throw console.log(i),i}}async function Experience(e){var n=await UserModel.find({isExperience:!0}),r=new UserModel(e),s=(r.pw=compressData(r.pw),"01".charAt(Math.floor(Math.random()*"01".length))),s=(r.gender=Number(s),r.name="유저 "+n.length,r.job="테스트 직업",r.email={value:`test${n.length}@test.com`,isPublic:!0},r.phone={value:"0100000000"+n.length,isPublic:!0},new Date),n=s.getFullYear(),t=s.getMonth()+1,s=s.getDate();r.birth={value:""+n+t+s,isPublic:!0},r.hashTag=["테스트 계정입니다.","본인의 이력을 등록해보세요.","지금까지 진행한 프로젝트들을 등록해보세요","본인과 관련된 문장, 단어를 추가해보세요.","본인을 나타내는 프로필 이미지를 등록해보세요.","id : "+e.id,"pw : "+e.pw,"계정은 밤12시 삭제 됩니다.","헤더의 햄버거 버튼을 클릭해 본인의 포트폴리오를 확인 해보세요."],r.isExperience=!0,r.profileImg="";let a=r.id,o=path.join(__dirname,"..","..","/"+process.env.FILE_DIRECTORY_NAME);fs.mkdir(path.join(""+o,a),e=>{if(e)return console.log(e);fs.mkdir(path.join(o+"/"+a,"profile"),e=>{if(e)return console.log(e)}),fs.mkdir(path.join(o+"/"+a,"file"),e=>{if(e)return console.log(e)})}),r.save();n=SetToken(r.id),t=SetToken(r.id,!0),s=JSON.stringify({a:n,r:t});return new ResultResponse(200,compressData(s))}async function Login(e,n){try{var r,s,t,a=await UserModel.findOne({id:e});return a?a.pw===compressData(n)?(r=SetToken(a.id),s=SetToken(a.id,!0),t=JSON.stringify({a:r,r:s}),new ResultResponse(200,compressData(t))):new ResultResponse(403,null,"wrong Password"):new ResultResponse(403,null,"null User")}catch(e){throw ResultResponse(400,e,"Login API error")}}function Logout(e){try{return e.a=null,e.r=null,new ResultResponse(200,"logout success")}catch(e){throw new ResultResponse(400,data,"Logout Error error")}}async function IdSearch(e){try{var{name:n,email:r,phone:s}=e,t=await UserModel.findOne({name:n,"email.value":r,"phone.value":s});return t?new ResultResponse(200,dataEncrypt(t.id)):new ResultResponse(403,null,"userInfo null")}catch(e){}}async function PwSearch(e){try{var{id:n,name:r,email:s,phone:t}=e;return await UserModel.findOne({id:n,name:r,"email.value":s,"phone.value":t})?new ResultResponse(200):new ResultResponse(403,null,"userInfo null")}catch(e){}}async function PwChange(e){try{var{id:n,pw:r}=e,s=await UserModel.findOne({id:n});return s?s.pw===compressData(r)?new ResultResponse(403,null,"same as previous pw"):(s.pw=compressData(r),s.save(),new ResultResponse(200)):new ResultResponse(403,null,"userInfo null")}catch(e){}}async function Withdrawal(e){try{await UserModel.findOne({id:e});var n=path.join(__dirname,"..","..","/"+process.env.FILE_DIRECTORY_NAME),r=path.join(n,e),s=await UserModel.deleteOne({id:e});return 0===s.deletedCount?new ResultResponse(403,s,"withdrawal fail"):(fs.existsSync(r)&&fs.rmSync(r,{recursive:!0,force:!0}),new ResultResponse(200))}catch(e){console.log(e,"Withdrawal err")}}module.exports={Register:Register,Experience:Experience,Login:Login,Logout:Logout,IdSearch:IdSearch,PwSearch:PwSearch,PwChange:PwChange,Withdrawal:Withdrawal};// build date : 2024. 12. 23. 오후 10:15:20