let fs=require("fs"),path=require("path"),v4=require("uuid").v4,UserModel=require("../model/user").UserModel,dataEncrypt=require("../util/crpyto").dataEncrypt,ResultResponse=require("../util/resultResponse");async function getProfileImg(e){try{var t={id:e},r=await UserModel.findOne(t),s={user:r.id,img:r.profileImg,gender:r.gender};return new ResultResponse(200,dataEncrypt(s))}catch(e){throw new ResultResponse(400,e,"getProfileImg ERROR")}}function setProfileImg(p,R){try{return new Promise((n,o)=>{if(!p||!R)throw"error";var e=path.join(__dirname,"..","..",process.env.FILE_DIRECTORY_NAME);let i=R.item,l=v4()+(new Date).getTime()+path.extname(i.name),u=path.join(e,p,"profile"),a=path.join(u,l);fs.readdir(u,(e,r)=>{if(e)return o(new ResultResponse(400,e,"폴더 조회 실패"));if(0===r.length)i.mv(a,e=>{if(e)return o(new ResultResponse(400,R,e));UserModel.updateOne({id:p},{profileImg:l}).then(e=>{n(new ResultResponse(200))}).catch(e=>{n(new ResultResponse(400,R,e))})});else for(let t=0;t<r.length;t++){var s=path.join(u,r[t]);fs.unlink(s,e=>{if(e)return o(new ResultResponse(400,e,"기존 파일 삭제 실패"));t===r.length-1&&i.mv(a,e=>{if(e)return new ResultResponse(400,R,e);UserModel.updateOne({id:p},{profileImg:l}).then(e=>{n(new ResultResponse(200))}).catch(e=>o(new ResultResponse(400,R,e)))})})}})})}catch(e){var t=new ResultResponse(404,e.stack,e.message);throw console.log(t),t}}module.exports={getProfileImg:getProfileImg,setProfileImg:setProfileImg};// build date : 2024. 12. 23. 오후 10:15:20